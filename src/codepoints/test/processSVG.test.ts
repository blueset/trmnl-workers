import { describe, it, expect } from "vitest";
import { processSVG } from "../utils";
import { CodepointMeta } from "../types";

// Minimal meta factory: only field used is _?.imagesource
function meta(imagesource: string | undefined | null): CodepointMeta {
  return {
    _: {
      imagesource: imagesource || "",
      image: "",
      description: "",
      wikipedia: null,
    },
  } as unknown as CodepointMeta;
}

// Real frozen SVG for U+316F (fetched 2025-09-08 from https://codepoints.net/api/v1/glyph/316F)
const svg316F = `<svg xmlns="http://www.w3.org/2000/svg" id="U316F" viewBox="0 0 920 1000"><path transform="translate(0, 900) scale(1,-1)" d="M378 549L378 210L226 210L226 549ZM609 620L609 452C609 351 560 244 451 197L451 616L153 616L153 143L451 143L451 186L489 133C569 168 621 232 649 307C676 232 727 168 808 133L852 194C739 240 688 349 688 452L688 620Z"/></svg>`;

// Real frozen SVG for U+66DC (fetched 2025-09-08 from https://codepoints.net/api/v1/glyph/66DC)
const svg66DC = `<svg xmlns="http://www.w3.org/2000/svg" id="U66DC" viewBox="0 0 1000 1000"><svg id="U66DChk" viewBox="0 0 1000 1000"><path transform="translate(0, 900) scale(1,-1)" d="M368 557L401 510C450 537 504 569 558 601L543 644C477 611 413 577 368 557ZM383 703C423 684 474 656 501 638L531 679C503 696 452 722 414 738ZM675 558L708 510C754 536 807 567 857 598L843 642C780 609 719 577 675 558ZM688 702C725 683 774 655 800 636L829 677C804 694 756 721 718 737ZM256 414L256 185L136 185L136 414ZM256 481L136 481L136 703L256 703ZM74 771L74 36L136 36L136 117L318 117L318 771ZM491 210L665 210L665 142L491 142ZM491 264L491 332L665 332L665 264ZM368 815L368 759L573 759L573 535C573 526 570 523 559 522C548 522 513 522 474 523C480 510 487 491 490 477L478 481C449 398 389 294 328 227C339 212 355 180 363 164C383 186 403 212 423 239L423-79L491-79L491-40L956-40L956 18L734 18L734 89L901 89L901 142L734 142L734 210L901 210L901 264L734 264L734 332L934 332L934 391L734 391C723 418 707 452 692 479L628 461C639 440 651 414 660 391L516 391C528 413 539 435 548 456L509 470C555 470 586 471 607 480C630 490 635 505 635 535L635 815ZM491 89L665 89L665 18L491 18ZM667 816L667 759L866 759L866 526C866 516 863 513 852 513C842 512 807 512 767 513C774 498 782 477 786 461C841 461 876 462 899 471C922 480 927 495 927 526L927 816Z"/><animate attributeName="opacity" values="1;0;0;0;0;0;0;1;1" dur="4s" repeatCount="indefinite"/></svg><svg id="U66DCjp" viewBox="0 0 1000 1000"><path transform="translate(0, 900) scale(1,-1)" d="M77 777L77 30L144 30L144 113L335 113L335 245C344 235 353 224 359 216C382 236 405 258 426 283L426-75L495-75L495-44L960-44L960 15L717 15L717 97L911 97L911 150L717 150L717 227L911 227L911 281L717 281L717 357L935 357L935 416L735 416L773 487L734 496L928 496L928 803L670 803L670 748L861 748L861 677L685 677L685 625L861 625L861 550L669 550L669 496L696 496C688 472 676 442 665 416L521 416C535 440 548 464 559 488L532 496L629 496L629 803L377 803L377 748L563 748L563 677L394 677L394 625L563 625L563 550L376 550L376 496L484 496C453 425 397 343 335 285L335 777ZM495 227L651 227L651 150L495 150ZM495 281L495 357L651 357L651 281ZM495 97L651 97L651 15L495 15ZM267 418L267 180L144 180L144 418ZM267 485L144 485L144 710L267 710Z"/><animate attributeName="opacity" values="0;1;1;0;0;0;0;0;0" dur="4s" repeatCount="indefinite"/></svg><svg id="U66DCkr" viewBox="0 0 1000 1000"><path transform="translate(0, 900) scale(1,-1)" d="M497 205L656 205L656 137L497 137ZM497 258L497 327L656 327L656 258ZM75 764L75 35L142 35L142 114L334 114L334 225C347 215 361 201 369 191C390 211 410 233 429 258L429-81L497-81L497-46L960-46L960 13L722 13L722 84L904 84L904 137L722 137L722 205L904 205L904 258L722 258L722 327L933 327L933 385L727 385C741 410 757 438 771 466L698 483C689 455 673 416 658 385L515 385C534 417 550 449 564 480L494 502C463 420 401 321 334 252L334 764ZM497 84L656 84L656 13L497 13ZM267 410L267 181L142 181L142 410ZM267 477L142 477L142 697L267 697ZM526 661C485 602 415 548 346 510C360 501 382 481 392 470C454 508 522 566 568 626L568 488L629 488L629 804L376 804L376 749L567 749L567 626C489 591 414 557 359 537ZM659 537L678 479L860 566L860 484L926 484L926 804L669 804L669 749L860 749L860 623C784 589 711 556 659 537ZM256 414L256 185L136 185L136 414ZM256 481L136 481L136 703L256 703ZM74 771L74 36L136 36L136 117L318 117L318 771Z"/><animate attributeName="opacity" values="0;0;0;1;1;0;0;0;0" dur="4s" repeatCount="indefinite"/></svg><svg id="U66DCsc" viewBox="0 0 1000 1000"><path transform="translate(0, 900) scale(1,-1)" d="M691 694C722 667 762 630 782 606L818 646C798 669 758 704 727 729ZM391 694C422 667 462 630 483 606L519 646C499 669 458 704 427 729ZM497 212L669 212L669 142L497 142ZM497 266L497 332L669 332L669 266ZM637 461C648 440 659 414 669 391L519 391C534 416 547 441 559 465L490 489C456 407 388 304 320 237C335 226 358 204 371 191C391 211 410 233 429 257L429-79L497-79L497-40L952-40L952 18L736 18L736 89L905 89L905 142L736 142L736 212L905 212L905 266L736 266L736 332L934 332L934 391L742 391C731 419 714 454 699 481ZM497 89L669 89L669 18L497 18ZM359 537L379 479L567 569L567 488L630 488L630 804L373 804L373 749L567 749L567 626C489 591 414 557 359 537ZM659 537L678 479L860 566L860 484L926 484L926 804L669 804L669 749L860 749L860 623C784 589 711 556 659 537ZM256 414L256 185L136 185L136 414ZM256 481L136 481L136 703L256 703ZM74 771L74 36L136 36L136 117L318 117L318 771Z"/><animate attributeName="opacity" values="0;0;0;0;0;1;1;0;0" dur="4s" repeatCount="indefinite"/></svg></svg>`;

describe("processSVG", () => {
  it("returns single array with original svg for 316F (no nested children)", () => {
    const out = processSVG(svg316F, meta("Codepoints"));
    expect(out).toStrictEqual([{ svg: svg316F, font: "Codepoints" }]);
  });

  it("extracts variant child svgs for 66DC and removes <animate>", () => {
    const out = processSVG(svg66DC, meta("Codepoints"));
    expect(out).toStrictEqual([
      {
        svg: '<svg id="U66DChk" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg"><path transform="translate(0, 900) scale(1,-1)" d="M368 557L401 510C450 537 504 569 558 601L543 644C477 611 413 577 368 557ZM383 703C423 684 474 656 501 638L531 679C503 696 452 722 414 738ZM675 558L708 510C754 536 807 567 857 598L843 642C780 609 719 577 675 558ZM688 702C725 683 774 655 800 636L829 677C804 694 756 721 718 737ZM256 414L256 185L136 185L136 414ZM256 481L136 481L136 703L256 703ZM74 771L74 36L136 36L136 117L318 117L318 771ZM491 210L665 210L665 142L491 142ZM491 264L491 332L665 332L665 264ZM368 815L368 759L573 759L573 535C573 526 570 523 559 522C548 522 513 522 474 523C480 510 487 491 490 477L478 481C449 398 389 294 328 227C339 212 355 180 363 164C383 186 403 212 423 239L423-79L491-79L491-40L956-40L956 18L734 18L734 89L901 89L901 142L734 142L734 210L901 210L901 264L734 264L734 332L934 332L934 391L734 391C723 418 707 452 692 479L628 461C639 440 651 414 660 391L516 391C528 413 539 435 548 456L509 470C555 470 586 471 607 480C630 490 635 505 635 535L635 815ZM491 89L665 89L665 18L491 18ZM667 816L667 759L866 759L866 526C866 516 863 513 852 513C842 512 807 512 767 513C774 498 782 477 786 461C841 461 876 462 899 471C922 480 927 495 927 526L927 816Z"></path></svg>',
        font: "Codepoints HK",
      },
      {
        svg: '<svg id="U66DCjp" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg"><path transform="translate(0, 900) scale(1,-1)" d="M77 777L77 30L144 30L144 113L335 113L335 245C344 235 353 224 359 216C382 236 405 258 426 283L426-75L495-75L495-44L960-44L960 15L717 15L717 97L911 97L911 150L717 150L717 227L911 227L911 281L717 281L717 357L935 357L935 416L735 416L773 487L734 496L928 496L928 803L670 803L670 748L861 748L861 677L685 677L685 625L861 625L861 550L669 550L669 496L696 496C688 472 676 442 665 416L521 416C535 440 548 464 559 488L532 496L629 496L629 803L377 803L377 748L563 748L563 677L394 677L394 625L563 625L563 550L376 550L376 496L484 496C453 425 397 343 335 285L335 777ZM495 227L651 227L651 150L495 150ZM495 281L495 357L651 357L651 281ZM495 97L651 97L651 15L495 15ZM267 418L267 180L144 180L144 418ZM267 485L144 485L144 710L267 710Z"></path></svg>',
        font: "Codepoints JP",
      },
      {
        svg: '<svg id="U66DCkr" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg"><path transform="translate(0, 900) scale(1,-1)" d="M497 205L656 205L656 137L497 137ZM497 258L497 327L656 327L656 258ZM75 764L75 35L142 35L142 114L334 114L334 225C347 215 361 201 369 191C390 211 410 233 429 258L429-81L497-81L497-46L960-46L960 13L722 13L722 84L904 84L904 137L722 137L722 205L904 205L904 258L722 258L722 327L933 327L933 385L727 385C741 410 757 438 771 466L698 483C689 455 673 416 658 385L515 385C534 417 550 449 564 480L494 502C463 420 401 321 334 252L334 764ZM497 84L656 84L656 13L497 13ZM267 410L267 181L142 181L142 410ZM267 477L142 477L142 697L267 697ZM526 661C485 602 415 548 346 510C360 501 382 481 392 470C454 508 522 566 568 626L568 488L629 488L629 804L376 804L376 749L567 749L567 626C489 591 414 557 359 537ZM659 537L678 479L860 566L860 484L926 484L926 804L669 804L669 749L860 749L860 623C784 589 711 556 659 537ZM256 414L256 185L136 185L136 414ZM256 481L136 481L136 703L256 703ZM74 771L74 36L136 36L136 117L318 117L318 771Z"></path></svg>',
        font: "Codepoints KR",
      },
      {
        svg: '<svg id="U66DCsc" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg"><path transform="translate(0, 900) scale(1,-1)" d="M691 694C722 667 762 630 782 606L818 646C798 669 758 704 727 729ZM391 694C422 667 462 630 483 606L519 646C499 669 458 704 427 729ZM497 212L669 212L669 142L497 142ZM497 266L497 332L669 332L669 266ZM637 461C648 440 659 414 669 391L519 391C534 416 547 441 559 465L490 489C456 407 388 304 320 237C335 226 358 204 371 191C391 211 410 233 429 257L429-79L497-79L497-40L952-40L952 18L736 18L736 89L905 89L905 142L736 142L736 212L905 212L905 266L736 266L736 332L934 332L934 391L742 391C731 419 714 454 699 481ZM497 89L669 89L669 18L497 18ZM359 537L379 479L567 569L567 488L630 488L630 804L373 804L373 749L567 749L567 626C489 591 414 557 359 537ZM659 537L678 479L860 566L860 484L926 484L926 804L669 804L669 749L860 749L860 623C784 589 711 556 659 537ZM256 414L256 185L136 185L136 414ZM256 481L136 481L136 703L256 703ZM74 771L74 36L136 36L136 117L318 117L318 771Z"></path></svg>',
        font: "Codepoints SC",
      },
    ]);
  });
});
